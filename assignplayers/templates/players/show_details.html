{% extends 'players/base.html' %}
{% load static %}

{% block content %}
    <div class="container">
        <div class="jumbotron">
            <div class="breadcrumb">
                <div class="items">
                </div>
            </div>
            <div id="dvtree">
            </div>
        </div>
    </div>

<script>
    let str='';
    let txt = '';
    let treeData = '';
    let nullParents = [];
    let notNullParents = [];
    var index = '';
    var indexes = [];
    var uniqueArray = [];
    let res = "{{pk}}";
    $.ajax({
        url: '/return_json_value/'+res+'/',
        type: 'GET',
        crossDomain: true,
        datatype: "jsonp",
        success: function(data) {
            treeData = data.json_data;
            createTree();
	}

});

    function createTree(){
        str=str+'<ul>';
        for (let i = 0; i < treeData.length; i++) {
            if(treeData[i]["ParentId"] === null){
                str=str+'<li>\
                <input type="checkbox" class="box" id="box" onclick="indeterminateCall('+treeData[i]["NodeId"].toString()+');">\
                <a href="#" onclick="populateTree('+treeData[i]["NodeId"].toString()+');">'+treeData[i]["NodeTitle"]+'</a></li>';
            }
        }

        str=str+'</ul>';

        $("#dvtree").html(str);

    }


    function populateTree(parentid)
    {
        let str = '';
        str=str+'<ul>';

        for (let i = 0; i < treeData.length; i++) {
            if(treeData[i]["ParentId"] !== null)
            {
            if(treeData[i]["ParentId"].toString() === parentid.toString())
            {
                if(treeData[i].checked){
                    str=str+'<li>\
                <input type="checkbox" class="box" id="box" checked="true" onclick="indeterminateCall('+treeData[i]["NodeId"].toString()+');">\
                <a href="#" onclick="populateTree('+treeData[i]["NodeId"].toString()+');">'+treeData[i]["NodeTitle"]+'</a></li>';
                }
                else{
                    str=str+'<li>\
                <input type="checkbox" class="box" id="box" onclick="indeterminateCall('+treeData[i]["NodeId"].toString()+');">\
                <a href="#" onclick="populateTree('+treeData[i]["NodeId"].toString()+');">'+treeData[i]["NodeTitle"]+'</a></li>';
                }
             }

            }
        }

        str=str+'</ul>';
        $("#dvtree").html(str);
         $(".items").empty();
        GetCrumb(parentid);
    }

function GetCrumb(id)
{
            for (let i = 0; i < treeData.length; i++) {

                if(treeData[i]["ParentId"] !== null)
                {
                    if(treeData[i]["NodeId"].toString() === id.toString())
                    {
                        $(".items").prepend(' > <a href="#" onclick="populateTree('+treeData[i]["NodeId"].toString()+');">'+treeData[i]["NodeTitle"].toString()+'</a>');
                        console.log(treeData[i]);
                        return GetCrumb(treeData[i]["ParentId"]);
                    }
                }
                else
                {
                    if(treeData[i]["NodeId"].toString() === id.toString())
                    { $(".items").prepend('<a href="#" onclick="populateTree('+treeData[i]["NodeId"].toString()+');">'+treeData[i]["NodeTitle"].toString()+'</a>');
                    }
                }
        }
<!--        return 0;-->
}


function indeterminateCall(id){

    for (var i=0; i<treeData.length; i++){
        if(treeData[i]["ParentId"] !== null){
            if(treeData[i]["NodeId"].toString() === id.toString()){
                treeData[i].checked = "true";
            }
             index = treeData[i].checked;
             if(index){
                indexes.push(treeData[i]);
             }
        }
        else{
                 if(treeData[i]["NodeId"].toString() === id.toString()){
                treeData[i].checked = true;
            }
             index = treeData[i].checked;
             if(index){
                indexes.push(treeData[i]);
             }
        }
    }
    jsonObject = indexes.map(JSON.stringify);
    uniqueSet = new Set(jsonObject);
    uniqueArray = Array.from(uniqueSet).map(JSON.parse);

    console.log(uniqueArray);
}

</script>
{% endblock %}